services:
    redis:
        image: redis:7-alpine
        ports:
            - "6379:6379"
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5

    backend-web:
        build: ./backend
        command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload
        ports:
            - "8000:8000"
        volumes:
            - ./backend:/app
            - ./backend/generated_media:/app/generated_media # ← Backend!
        environment:
            - REDIS_HOST=redis
        depends_on:
            redis:
                condition: service_healthy
        restart: unless-stopped

    backend-worker:
        build: ./backend
        command: celery -A celery_worker worker --loglevel=info --concurrency=4
        volumes:
            - ./backend/generated_media:/app/generated_media # ← Backend!
        environment:
            - REDIS_HOST=redis
        depends_on:
            - redis
            - backend-web
        restart: unless-stopped

    frontend:
        build: ./frontend
        ports:
            - "3000:3000"
        volumes:
            - ./frontend:/app
            - /app/node_modules
            - ./backend/generated_media:/app/public/media # ← Backend → Frontend!
        environment:
            - NEXT_PUBLIC_API_URL=http://localhost:8000
        depends_on:
            - backend-web
        restart: unless-stopped
