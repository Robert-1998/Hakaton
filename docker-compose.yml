services:
    redis:
        image: redis:7-alpine
        ports: ["6379:6379"]
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5

    backend-web: # ✅ Переименовали (build: ./backend)
        build: ./backend # Относительно hakaton/
        command: uvicorn main:app --host 0.0.0.0 --port 8000 # ❌ Убрали --reload
        volumes:
            - ./generated_media:/app/generated_media
        ports: ["8000:8000"]
        environment:
            - REDIS_HOST=redis
        depends_on:
            redis:
                condition: service_healthy
        restart: unless-stopped

    backend-worker:
        build: ./backend
        command: celery -A celery_worker worker --loglevel=info --concurrency=4 # ✅ celery_app → celery_worker
        volumes:
            - ./generated_media:/app/generated_media
        environment:
            - REDIS_HOST=redis
        depends_on:
            redis:
                condition: service_healthy
        restart: unless-stopped

    # ✅ Frontend сервис
    frontend:
        build: ./frontend
        ports: ["3000:3000"]

volumes:
    generated_media: # Persistent
